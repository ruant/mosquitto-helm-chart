# Default values for mosquitto.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

image:
  repository: eclipse-mosquitto
  pullPolicy: IfNotPresent
  tag: "2.0.22"

# =============================================================================
# LISTENER CONFIGURATION
# =============================================================================
# Configure which MQTT listeners are enabled
# You can enable/disable each listener type independently for maximum flexibility

listeners:
  # Plain MQTT (unencrypted TCP connection)
  # Disable this for secure-only deployments
  mqtt:
    enabled: true
    port: 1883

  # MQTT over WebSocket
  # Choose between ingress TLS (tls.enabled: false) or direct TLS (tls.enabled: true)
  websocket:
    enabled: true
    port: 9001
    tls:
      # Enable direct TLS termination by Mosquitto for WebSocket
      # Set to false if using nginx ingress for TLS termination
      enabled: false
      # # WebSocket TLS configuration (uncomment when tls.enabled: true)
      # secretName: "websocket-tls-secret"
      # certKey: "tls.crt"
      # keyKey: "tls.key"
      # # Optional settings for WebSocket TLS
      # caKey: "ca.crt"
      # requireClientCerts: false
      # # Custom cipher suites (WebSocket TLS limitation - only these options supported)
      # ciphers: "ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305"
      # ciphersTls13: "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256"

    # Kubernetes Ingress for WebSocket (alternative to direct TLS)
    # Use this when you want nginx/ingress-controller to handle TLS termination
    # Note: Set tls.enabled=false when using ingress for TLS
    ingress:
      enabled: false
      # # Ingress configuration (uncomment when enabled: true)
      # className: "nginx"
      # annotations:
      #   kubernetes.io/ingress.class: nginx
      #   kubernetes.io/tls-acme: "true"
      #   cert-manager.io/cluster-issuer: "letsencrypt-prod"
      # hosts:
      #   - host: mqtt-ws.example.com
      #     paths:
      #       - path: /
      #         pathType: Prefix
      # tls:
      #   - secretName: mqtt-websocket-tls
      #     hosts:
      #       - mqtt-ws.example.com

  # MQTT over TLS (encrypted TCP connection)
  # Direct TLS encryption handled by Mosquitto using cert-manager certificates
  mqttTls:
    enabled: false
    port: 8883
    # # MQTT TLS configuration (uncomment when enabled: true)
    # tls:
    #   # Kubernetes secret containing TLS certificate and key (cert-manager or manual)
    #   secretName: "mqtt-tls-secret"
    #   certKey: "tls.crt"
    #   keyKey: "tls.key"
    #   # TLS version and security settings
    #   minVersion: "tlsv1.2"
    #   # # Advanced TLS options (available for MQTT TLS, not WebSocket TLS)
    #   # caKey: "ca.crt"
    #   # requireClientCerts: false
    #   # useClientCertAsUsername: false
    #   # # Custom cipher suites
    #   # ciphers: "ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305"
    #   # ciphersTls13: "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256"

# =============================================================================
# GENERAL MOSQUITTO CONFIGURATION
# =============================================================================

general:
  maxInflightMessages: 20
  maxQueuedMessages: 1000

auth:
  enabled: true
  # # Use an existing secret for user passwords (optional)
  # usersExistingSecret: "mqtt-users-secret"
  users:
    - username: admin
      # "admin" password in sha512-pbkdf2 format, generated with mosquitto_passwd
      password: $7$101$T1RBXD5MGIImHq8g$hSCHVAyZtAif0qN9Fhuam9mVCd0xLomREHIwzdreGjjADCQewz9VpfhK6AumcZyVFHFpHd2EhZdqU+Lq7393Xw==
      acl:
        - topic: "#"
          access: readwrite

# # Image pull secrets (uncomment if needed for private registries)
# imagePullSecrets:
#   - name: "my-registry-secret"

# # Chart name overrides (optional)
# nameOverride: ""
# fullnameOverride: "my-mosquitto"

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # # Optional service account configuration
  # annotations:
  #   eks.amazonaws.com/role-arn: arn:aws:iam::123456789:role/mosquitto-role
  # name: "my-service-account"

# # Optional pod annotations
# podAnnotations:
#   prometheus.io/scrape: "true"
#   prometheus.io/port: "9090"

podSecurityContext:
  fsGroup: 1883

securityContext:
  capabilities:
    drop:
      - ALL
    add:
      - NET_BIND_SERVICE
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1883

service:
  # MQTT Service (for plain MQTT 1883 and MQTT TLS 8883)
  # Uses LoadBalancer for direct client connections to MQTT brokers
  mqtt:
    type: LoadBalancer
    # # MQTT service annotations (uncomment as needed)
    # annotations:
    #   # AWS Load Balancer Controller for MQTT
    #   service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    #   service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
    #   # GCP Load Balancer for MQTT
    #   cloud.google.com/load-balancer-type: "External"
    #   # MetalLB for MQTT
    #   metallb.universe.tf/address-pool: "production-public-ips"

  # WebSocket Service (for MQTT over WebSocket 9001)
  # Uses ClusterIP when ingress enabled, LoadBalancer for direct access
  websocket:
    type: ClusterIP
    # # WebSocket service annotations (uncomment as needed)
    # annotations:
    #   # Prometheus monitoring for WebSocket
    #   prometheus.io/scrape: "true"
    #   prometheus.io/port: "9001"
    #   # Istio service mesh for WebSocket
    #   traffic.sidecar.istio.io/includeInboundPorts: "9001"

# Resource limits and requests (recommended for production)
resources: {}
  # limits:
  #   cpu: 200m
  #   memory: 256Mi
  # requests:
  #   cpu: 100m
  #   memory: 128Mi

# # Node selection (optional)
# nodeSelector:
#   kubernetes.io/arch: amd64

# # Tolerations for node taints (optional)
# tolerations:
#   - key: "mqtt"
#     operator: "Equal"
#     value: "true"
#     effect: "NoSchedule"

# # Pod affinity/anti-affinity (optional)
# affinity:
#   nodeAffinity:
#     requiredDuringSchedulingIgnoredDuringExecution:
#       nodeSelectorTerms:
#       - matchExpressions:
#         - key: kubernetes.io/arch
#           operator: In
#           values:
#           - amd64
